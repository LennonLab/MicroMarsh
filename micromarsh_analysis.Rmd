---
title: "Bacterial community responses to salinization"
author: "Nathan Wisnoski"
date: '`r format(Sys.time(), "%d %B, %Y")`'
---

# Introduction
As a result of changing climate, coastal freshwater ecosystems are increasingly vulnerable to saltwater intrusion due to rising sea levels, and organisms that live in these areas may be experiencing rapid environmental change. However, it is unclear how the duration of salinization disturbance relates to the stability of ecological communities. In some areas, communities may be exposed to increased salinity for short durations at high intensities (i.e., a pulse disturbance), while in other areas, exposure to high salinity may persist indefinitely (i.e., a press disturbance). 

Under each type of disturbance regime, community stability can occur in several ways. First, some communities may undergo large changes in community structure (low resistance), while others may not change at all (high resistance). Second, communities may recover from perturbations quickly (high resilience), while others may take a long time to recover fully or may never reach their previous state (low resilience). In communities with low resistance and low resilience, there is the potential for the changing environmental conditions to create a tipping point, whereby shifts in community compositions are irrevocably altered, and so the community exists in a new state that may limit its ability to contend with future environmental uncertainty. 

Some organisms may possess traits that buffer against these rapid changes in the environment, increasing the stability of communities in response to disturbance and maintaining adaptive capacity to respond to uncertain future scenarios. One of these traits is metabolic dormancy, a reversible state of reduced metabolic activity that can buffer organisms against suboptimal environmental conditions and can maintain taxonomic, genetic, and functional diversity in a dormant seed bank. 

Among species that inhabit coastal ecosystems at risk for rapid change, bacterial communities are an ideal system in which to investigate stability in response to salinization disturbances. Here, we investigate how bacterial communities in tidal marshes respond to saltwater disturbances, and whether dormancy can buffer communities against rapidly changing environments. Specifically, we'll test the following hypotheses:

1. Pulse and press saltwater disturbances perturb bacterial communities, but press disturbances alter communities more strongly than pulse disturbances.  
2. Metabolically active (RNA-based) measures of bacterial diversity are more responsive to saltwater disturbances than total (DNA-based) measures of diversity, and may show greater sensitivity to environmental change. 


# Methods
To determine how different disturbance regimes affect bacterial community stability,  field experiments were conducted at the Georgia Coastal Ecosystems LTER site. The following three experimental treatments were established in the field:  
1. freshwater addition  
2. pulse saltwater disturbance  
3. press saltwater disturbance  
in comparison to a control where plastic siding was added without water additions. 


## Setup
```{r setup, include=FALSE}
library(tidyverse)
library(vegan)
library(viridis)
library(lubridate)
```

### Load and clean the data
A few things we'll need to do before moving forward with this:   
1. We need to take the raw sequence data from the DNA and cDNA libraries and analyze them together to create OTUs that are shared between both the DNA and cDNA libraries.  
2. It may also be interesting to take a look at the USV (unique sequence variant) approach, where we don't bin into OTUs, but rather look at sub-OTU-level variation in community structure.  


```{r, include=FALSE, message=FALSE}
# read in experimental design and change classes and sample names
design <- read_csv("data/design.csv",
   col_types = cols(
     sample_ID = col_character(), 
     date = col_date(format = "%m-%Y"),
     treatment = col_factor(levels = c("C", "CS", "F", "PU", "PR"), ordered = T),
     replicate = col_integer())) %>% 
  mutate(sample_ID = paste0("s", gsub("\\_", "", sample_ID))) %>% 
  arrange(date)
design <- rbind(
  cbind(design, molecule = "DNA"),
  cbind(design, molecule = "RNA")
)
design <- design %>% 
  mutate(sample_ID = ifelse(
    molecule == "DNA",
    sample_ID,
    paste0(sample_ID, "_cDNA")))

otus <- read_tsv("data/otu.tsv") %>% select(-taxonomy) %>% t()
colnames(otus) <- paste0("otu", (otus[1, ]))
otus <- otus[-1,]
otus[,1:10]

# # need to establish joint otus, they don't align between dna and rna data yet
# dna <- read_csv("data/DNA_otus.csv")
# rna <- read_csv("data/cDNA_otus.csv")

# dna.tax <- read_csv("data/DNA_otus.csv") %>% 
#   mutate(otu = `OTU ID`) %>% 
#   select(taxonomy, otu)
# 
# rna.tax <- read_csv("data/cDNA_otus.csv") %>% 
#   mutate(otu = `OTU ID`) %>% 
#   select(taxonomy, otu)


# create site by species matrices
rna <- otus[(rownames(otus) %>% endsWith("_cDNA")),]
dna <- otus[!(rownames(otus) %>% endsWith("_cDNA")),]

# make rownames of otutable match sample names
rnames <- gsub("7_1", "07_1", rownames(otus)) # make dates two digits
rnames <- gsub("3_1", "03_1", rnames)
rnames <- gsub("\\_", "", rnames) # remove underscores
rnames <- gsub("cDNA", "_cDNA", rnames)
rnames <- paste0("s",rnames)
rownames(otus) <- rnames


# coverage per sample and rarefy to lowest coverage
coverage <- rowSums(otus)
otus <- otus[which(coverage > 10000),]

otus <- rrarefy(otus,  min(coverage))


# update design object to reflect the samples
design <- inner_join(tibble(sample_ID = rownames(otus)), design) 

# reorder the otu table to match design
otus <- otus[match(design$sample_ID, rownames(otus)),]
all.equal.character(rownames(otus), design$sample_ID) # check that order is correct

# remove empty columns
otus <- otus[,-which(colSums(otus) == 0)]
```

### Subset data
Because many different things can influence bacterial community structure in the marsh over the course of a year (e.g., temperature, productivity), I subset the data to compare across years within the same time point to control for seasonal effects. I chose October, which had the potential to compare between years and is the month of the pulse disturbance. Here, though, I'm just going to select the second year of the experiment to ease visualization because the two years are similar.
```{r, message=FALSE, include=FALSE}
# check number of replicates per treatment x time
design %>% group_by(date, treatment) %>% count() %>% print(n = 100)

# just subset to the october treatments
my.month <- "October"
my.year <- c(2015, 2016)

design.sub <- design[which(months(design$date) %in% my.month & year(design$date) %in% my.year),]
otus.sub <- otus[which(months(design$date) %in% my.month & year(design$date) %in% my.year),]

# store full site by species matrix in otus.full and make 'otus' the subset
otus.full <- otus
otus <- otus.sub
design.full <- design
design <- design.sub
```

# Results
## How does the diversity of a local community change under our different experimental treatments?

For taxa to persist in a treatment, they must be able to grow locally or immigrate from elsewhere. Here, we just compare an estimate of local (alpha) diversity for the total DNA community and the metabolically active RNA community within each treatment. 
```{r, message=FALSE, fig.align='center', fig.height=5, fig.width=6}
otus.rich <- rowSums(decostand(otus, method = "pa"))
otus.alpha <- exp(diversity(otus, "shannon"))

data.frame(richness = otus.rich, diversity = otus.alpha) %>% rownames_to_column("sample_ID") %>% 
  left_join(design) %>% 
  group_by(date, treatment, molecule) %>%
  ggplot(aes(x = treatment, y = diversity, color = molecule, fill = molecule)) +
  # geom_point(alpha = 0.5) +
  geom_boxplot(position = position_dodge(), alpha = 0.5) +
  theme_minimal() + 
  facet_grid(~ date) +
  scale_color_viridis(begin = .2, end = .7, discrete = T) +
  scale_fill_viridis(begin = .2, end = .7, discrete = T) +
  labs(x = "Treatment", y = "Alpha diversity (species equivalents, D = 1)") +
  ggsave("figures/alpha.png", width = 7, height = 4, units = "in", dpi = 500)

```

Here we notice that the total community has consistently higher diversity overall, suggesting the ability to reduce metabolic activity can help maintain diversity. We also see that freshwater additions and pulse saltwater disturbances support higher alpha-diversity than the control, but press saltwater disturbances show a strong reduction in diversity, specifically in the metabolically active community. The maintenance of diversity in the freshwater and pulse treatments could be due to immigration and weak negative impacts of the pulse. The decrease in diversity with the press disturbance could result from driving freshwater taxa extinct and replacing them with marine taxa. 

## How does saltwater addition change community structure?

Here, we want to know about the diversity among sites (beta diversity). We would predict that the active community (RNA) would be more responsive and show greater shifts in composition than the total community (DNA). However, I need to re-run the sequence processing pipeline to make these two datasets more comparable. Therefore, the following analyses are done between communities within the RNA and DNA pools, but not between them. 
```{r, message=FALSE, fig.align='center', fig.height=5, fig.width=6}
otus.hel <- decostand(otus, method = "hellinger")
otus.dist <- vegdist(otus.hel, method = "euclidean")
otus.pcoa <- cmdscale(otus.dist, eig = T)
# explained variance
explained <- round(100*eigenvals(otus.pcoa)[c(1,2)]/sum(eigenvals(otus.pcoa)),1)
as.data.frame(scores(otus.pcoa)) %>% 
  rownames_to_column("sample_ID") %>% 
  left_join(design) %>% 
  ggplot(aes(x = Dim1, y = Dim2, color = treatment)) + 
  geom_point(size = 5, alpha = 0.6) + 
  coord_fixed() + 
  theme_minimal() +
  scale_color_viridis(begin = 0, end = .9, discrete = T) +
  labs(x = paste0("PCoA 1 (", explained[1],"%)"),
       y = paste0("PCoA 2 (", explained[2],"%)")) + 
  facet_wrap(~molecule) +
  stat_ellipse() +
  ggsave("figures/ordination.png", width = 10, height = 6, units = "in", dpi = 500)


perma.otus <- adonis(otus.hel ~ treatment * molecule, method = "euclidean", data = design)
perma.otus
```

From this preliminary analysis, it seems that there are not any systematic differences between the responses of DNA and RNA-based communities to the saltwater treatments. However, when the raw data has been reanalyzed through the same pipeline, we'll be able to compare the magnitude of responses and compare species-specific responses to the experimental manipulations. This should be much more informative. 

## Taxonomic analyses
```{r}
dna.tax.expand <- dna.tax %>% separate(taxonomy, into = c("domain", "phylum", "class", "order", "family", "genus", "species"), ";")
unique(dna.tax.expand$order)
desulf.tax <- c(
  "o:Desulfurellales",
  "o:Desulfovibrionales",
  "o:Desulfobacterales",
  "o:Desulfarculales",
  "o:Desulfuromonadales"
)
desulf.otus <- dna.tax.expand %>% filter(order %in% desulf.tax) %>% select(otu)
desulf.cols <- which(colnames(dna) %in% paste0("otu",desulf.otus$otu))
dna.rel <- decostand(dna, method = 'total')
as.data.frame(dna.rel[,desulf.cols]) %>% 
  rownames_to_column(var = "sample_ID") %>% 
  gather(-sample_ID, key = otu, value = abundance) %>% 
  left_join(design) %>% 
  group_by(date, treatment, otu) %>% 
  summarise(meanabund = mean(abundance), sdabund = sd(abundance)) %>%
  filter(meanabund > 0) %>%
  ggplot(aes(x = treatment, y = meanabund, color = otu)) +
  geom_point(show.legend = F) +
  theme_minimal() +
  facet_grid(. ~ date)


rna.tax.expand <- rna.tax %>% separate(taxonomy, into = c("domain", "phylum", "class", "order", "family", "genus", "species"), ";")
unique(rna.tax.expand$order)
desulf.tax <- c(
  "o:Desulfurellales",
  "o:Desulfovibrionales",
  "o:Desulfobacterales",
  "o:Desulfarculales",
  "o:Desulfuromonadales"
)
desulf.otus <- rna.tax.expand %>% filter(order %in% desulf.tax) %>% select(otu)
desulf.cols <- which(colnames(rna) %in% paste0("otu",desulf.otus$otu))
rna.rel <- decostand(rna, method = 'total')
as.data.frame(rna.rel[,desulf.cols]) %>% 
  rownames_to_column(var = "sample_ID") %>% 
  gather(-sample_ID, key = otu, value = abundance) %>% 
  left_join(design) %>% 
  group_by(date, treatment, otu) %>% 
  summarise(meanabund = mean(abundance), sdabund = sd(abundance)) %>%
  filter(meanabund > 0) %>%
  ggplot(aes(x = treatment, y = meanabund, color = otu)) +
  geom_point(show.legend = F) +
  theme_minimal() +
  facet_grid(. ~ date)
```

# Preliminary conclusions
However, even with the current analysis, we can say some things conclusively. The press disturbance does have a strong effect on the structure of the total and active communities, suggesting saltwater intrusion may have lasting effects on composition. Indeed, the PERMANOVA indicates that treatment variable explains more of the variation in the total bacterial communities than in the active communities. 

In contrast to the press disturbance, the pulse disturbance does not cause strong deviations from the freshwater community, which suggests that short-term intrusions may not lead to tipping points in these bacterial communities, suggesting that they have some degree of resistence and possibly resilience (which I could assess in some of the other time points).